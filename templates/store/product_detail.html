{% extends "base.html" %}
{% load static %}

{% block content %}

<section class="section-content padding-y bg">
    <div class="container">

        <div class="card">
            <div class="row no-gutters">

                <!-- PRODUCT IMAGE -->
                <aside class="col-md-6">
                    <article class="gallery-wrap">
                        <div class="img-big-wrap">
                            <img src="{{ single_product.images.url }}" class="img-fluid">
                        </div>
                    </article>
                </aside>

                <!-- PRODUCT DETAILS -->
                <main class="col-md-6 border-left">
                    <article class="content-body">

                        <h2 class="title">{{ single_product.product_name }}</h2>

                        <div class="mb-3">
                            <var class="price h4">â‚¹ {{ single_product.price }}</var>
                        </div>

                        <p>{{ single_product.description }}</p>

                        <hr>

                        {% if single_product.stock <= 0 %} <button class="btn btn-secondary" disabled>Out of
                            Stock</button>
                            {% else %}

                            <form id="addToCartForm" action="{% url 'add_cart' single_product.id %}" method="POST">
                                {% csrf_token %}

                                <div class="mb-3">
                                    <h6>Choose Color</h6>
                                    <select name="color" id="colorSelect" class="form-control" required>
                                        <option value="">Select Color</option>
                                        {% for color in color_size_map.keys %}
                                        <option value="{{ color }}">{{ color }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <h6>Select Size</h6>
                                    <div id="sizeButtons" class="d-flex flex-wrap">
                                        {% for size in all_sizes %}
                                        <button type="button" class="btn btn-outline-secondary m-1 size-btn"
                                            data-size="{{ size }}" disabled>
                                            {{ size }}
                                        </button>
                                        {% endfor %}
                                    </div>

                                    <input type="hidden" name="size" id="selectedSize">
                                </div>

                                <button id="cartBtn" type="submit" class="btn btn-primary">
                                    Add to Cart
                                </button>
                            </form>

                            {% endif %}

                    </article>
                </main>

            </div>
        </div>

    </div>
</section>

<!-- JS -->
<script>
    const colorSizeMap = {{ color_size_map| safe }};
    const productId = "{{ single_product.id }}";

    const colorSelect = document.getElementById('colorSelect');
    const sizeButtons = document.querySelectorAll('.size-btn');
    const sizeInput = document.getElementById('selectedSize');
    const cartBtn = document.getElementById('cartBtn');

    // RESET button to default
    function resetCartButton() {
        cartBtn.innerText = 'Add to Cart';
        cartBtn.disabled = false;
    }

    // When COLOR changes
    colorSelect.addEventListener('change', () => {
        const selectedColor = colorSelect.value;
        console.log(selectedColor)

        // reset size
        sizeInput.value = '';
        resetCartButton();

        sizeButtons.forEach(btn => {
            btn.classList.remove('active');
            btn.disabled = true;

            if (selectedColor && colorSizeMap[selectedColor]?.includes(btn.dataset.size)) {
                btn.disabled = false;
            }
        });
    });

    // When SIZE clicked
    sizeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            sizeButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            sizeInput.value = btn.dataset.size;
            resetCartButton();

            checkCart();
        });
    });

    function checkCart() {
        const color = colorSelect.value;
        const size = sizeInput.value;

        if (!color || !size) return;

        fetch(`/cart/check-cart-variation/?product_id=${productId}&color=${color}&size=${size}`)
            .then(res => res.json())
            .then(data => {
                if (data.in_cart) {
                    console.log(data)
                    cartBtn.innerText = 'Added to Cart';
                    cartBtn.disabled = true;
                } else {
                    resetCartButton();
                }
            });
    }
</script>

<style>
    .size-btn.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
</style>

{% endblock %}